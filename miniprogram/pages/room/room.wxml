<!--pages/room/room.wxml-->
<view class="main-container">
  <view class="left-section">
    <view class="members-section">
      <scroll-view class="members-scroll" scroll-y scroll-with-animation>
        <view class="members-list">
          <view class="member-item" wx:for="{{room.members}}" wx:key="index" bindtap="handleMemberTap" data-index="{{index}}">
            <view class="creator-tag" wx:if="{{item.name === room.creator}}">æˆ¿ä¸»</view>
            <view class="member-square">
              <image class="member-avatar" src="{{item.avatarUrl || '/images/avatar.png'}}"></image>
              <text class="member-name">{{item.name}}</text>
              <view class="score-container {{item.score > 0 ? 'positive' : (item.score < 0 ? 'negative' : '')}}" wx:if="{{item.score !== 0}}">
                <text class="member-score {{item.scoreScroll ? 'scroll' : ''}}">{{item.score > 0 ? '+' : ''}}{{item.score}}</text>
              </view>
            </view>
          </view>
          <view class="member-item add-member" wx:if="{{room.status === 'playing'}}" bindtap="addMember">
            <view class="member-square add-square">
              <view class="add-avatar">+</view>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>

    <view class="left-bottom-buttons" wx:if="{{isCreator}}">
      <view class="left-btn invite-btn" bindtap="showQrcode">
        <text class="left-btn-icon">ğŸ“¤</text>
        <text class="left-btn-text">é‚€è¯·</text>
      </view>
      <view class="left-btn settings-btn" bindtap="openSettingsModal">
        <text class="left-btn-icon">âš™ï¸</text>
        <text class="left-btn-text">è®¾ç½®</text>
      </view>
    </view>
  </view>

  <view class="right-section">
    <view class="prize-pool-section" wx:if="{{room.gameMode === 'bet'}}">
      <view class="prize-pool-card">
        <view class="prize-pool-content" bindtap="transferToPrizePool">
          <view class="prize-pool-header">
            <text class="prize-pool-title">å…¬å…±å¥–æ± </text>
            <text class="prize-pool-icon">ğŸ’°</text>
          </view>
          <view class="prize-pool-amount {{animateAmount ? 'animate' : ''}}">
            <text class="amount-number">{{room.prizePool.total}}</text>
            <text class="amount-unit">ç§¯åˆ†</text>
          </view>
          <view class="prize-pool-tip">ç‚¹å‡»å¥–æ± è½¬å…¥ç§¯åˆ†</view>
          <view class="receive-tip {{room.prizePool.receiver ? 'show' : ''}}">
            ã€{{room.prizePool.receiver}}ã€‘æ”¶å–äº†å¥–æ± 
          </view>
        </view>

        <view class="bet-actions-row" wx:if="{{room.status === 'playing'}}">
          <view class="bet-action-btn {{!canFollow ? 'disabled' : ''}}" bindtap="handleFollow">
            <text class="bet-action-text">è·Ÿ</text>
          </view>
          <view class="bet-action-btn" bindtap="handlePass">
            <text class="bet-action-text">è¿‡</text>
          </view>
          <view class="bet-action-btn {{!room.allInValue ? 'disabled' : ''}}" bindtap="handleAllIn">
            <text class="bet-action-text">all in</text>
          </view>
        </view>
      </view>

      <view class="receive-pool-btn {{room.prizePool.receiver ? 'disabled' : ''}}" wx:if="{{room.status === 'playing'}}" bindtap="receivePrizePool">
        æ”¶å–å¥–æ± 
      </view>
    </view>


    <view class="chat-section">
      <scroll-view class="chat-scroll" scroll-y scroll-with-animation scroll-into-view="{{scrollIntoView}}">
        <view class="chat-list">
          <view class="chat-message system" wx:if="{{showWelcome}}">
            <view class="bubble system">
              <text class="message-content">æ¬¢è¿è¿›å…¥ã€{{room.roomName}}ã€‘</text>
            </view>
          </view>

          <view class="chat-message {{item.isMe ? 'mine' : 'others'}} {{item.isSystem ? 'system' : ''}} {{item.detail && item.detail.type === 'transfer' ? 'transfer' : ''}}" wx:for="{{room.records}}" wx:key="index" bindtap="onRecordTap" data-record="{{item}}">
            <view class="avatar-container {{room.gameMode === 'bet' ? 'bet-avatar' : ''}}" wx:if="{{item.detail && item.detail.type !== 'settle' && item.detail.type !== 'welcome' && item.detail.type !== 'pass'}}">
              <block wx:if="{{room.gameMode === 'normal' && item.detail.type === 'transfer'}}">
                <image class="receiver-avatar {{item.isMe ? 'receiver-me' : 'receiver-other'}}" src="{{item.isMe ? item.detail.senderAvatar : item.detail.receiverAvatar || '/images/avatar.png'}}"></image>
                <image class="sender-avatar {{item.isMe ? 'sender-me' : 'sender-other'}}" src="{{item.isMe ? item.detail.receiverAvatar : item.detail.senderAvatar || '/images/avatar.png'}}"></image>
              </block>
              <image class="single-avatar {{item.isMe ? 'avatar-me' : 'avatar-other'}}" wx:elif="{{room.gameMode === 'normal'}}" src="{{item.detail.operatorAvatar || item.detail.avatarUrl || '/images/avatar.png'}}"></image>
              <image class="single-avatar {{item.isMe ? 'avatar-me' : 'avatar-other'}}" wx:elif="{{room.gameMode === 'bet'}}" src="{{item.detail.operatorAvatar || item.detail.avatarUrl || '/images/avatar.png'}}"></image>
            </view>

            <view class="bubble {{item.isMe ? 'mine' : 'others'}} {{item.isSystem ? 'system' : ''}} {{item.isReceive ? 'receive' : ''}}">
              <text class="message-time">{{item.time}}</text>
              <text class="message-content {{item.isReceive ? 'receive-text' : ''}}">
                <block wx:if="{{item.segments}}">
                  <text wx:for="{{item.segments}}" wx:for-item="segment" wx:key="index" class="{{segment.isMe ? 'me' : ''}} {{segment.isAmount ? 'transfer-amount' : ''}}">{{segment.text}}</text>
                </block>
                <block wx:else>{{item.processedDescription || item.description}}</block>
              </text>
            </view>
          </view>
        </view>
      </scroll-view>

      <view class="bottom-actions-container">
        <view class="action-btn expense-btn {{room.status !== 'playing' ? 'disabled' : ''}}" bindtap="handleExpenseBtn" wx:if="{{room.gameMode === 'normal'}}">
          <text class="btn-icon">ğŸ’¸</text>
          <text class="btn-text">æ”¯å‡º</text>
        </view>
        <view class="action-btn settle-btn {{room.status !== 'playing' ? 'disabled' : ''}}" bindtap="handleSettleBtn">
          <text class="btn-icon">ğŸ“‹</text>
          <text class="btn-text">{{room.status === 'playing' ? 'ç»“ç®—' : 'å·²ç»“ç®—'}}</text>
        </view>
      </view>
    </view>
  </view>
</view>

<view class="float-animation-container" wx:if="{{showFloatAnimation}}">
  <text class="float-amount" style="left: {{floatLeft}}px; top: {{floatTop}}px;">+{{floatAmount}}</text>
</view>

<view class="receive-animation-container" wx:if="{{showReceiveAnimation}}">
  <view class="receive-amount-display">
    <text class="receive-amount-text">+{{receiveAmount}}</text>
  </view>

  <view class="confetti-item" wx:for="{{confettiList}}" wx:key="id"
    style="left: {{item.left}}px; top: {{item.top}}px; background: {{item.color}}; width: {{item.width}}px; height: {{item.height}}px; animation-duration: {{item.duration}}ms; animation-delay: {{item.delay}}ms;">
  </view>
  <view class="coin-item" wx:for="{{coinList}}" wx:key="id"
    style="left: {{item.left}}px; top: {{item.top}}px; width: {{item.size}}px; height: {{item.size}}px; animation-duration: {{item.duration}}ms; animation-delay: {{item.delay}}ms;">
    <view class="coin-inner">
      <text class="coin-text">ğŸ’°</text>
    </view>
  </view>
</view>

<view class="modal-mask {{showExpenseModal ? 'show' : ''}}" wx:if="{{showExpenseModal}}" bindtap="closeExpenseModal"></view>
<view class="expense-modal {{showExpenseModal ? 'show' : ''}}" wx:if="{{showExpenseModal}}">
  <view class="modal-header">
    <text class="modal-title">æ‰¹é‡æ”¯å‡º</text>
    <text class="modal-close" bindtap="closeExpenseModal">âœ•</text>
  </view>
  <view class="modal-body">
    <view class="expense-info">
      <view class="info-row">
        <text class="info-label">æ”¯å‡ºæ–¹:</text>
        <text class="info-value">{{currentUser}}</text>
      </view>
    </view>
    <view class="expense-list">
      <view class="expense-item" wx:for="{{room.members}}" wx:key="name" wx:if="{{item.name !== currentUser}}">
        <view class="player-info">
          <image class="player-avatar" src="{{item.avatarUrl || '/images/avatar.png'}}"></image>
          <text class="player-name">{{item.name}}</text>
        </view>
        <view class="input-section">
          <input class="score-input" type="digit" placeholder="0" value="{{expenseAmounts[item.name] || ''}}" data-name="{{item.name}}" bindinput="onExpenseAmountInput" />
          <text class="score-unit">ç§¯åˆ†</text>
        </view>
      </view>
    </view>
    <view class="expense-total">
      <text class="total-label">æ€»è®¡æ”¯å‡º:</text>
      <text class="total-value">{{expenseTotal || 0}} ç§¯åˆ†</text>
    </view>
    <view class="modal-actions">
      <view class="action-btn cancel" bindtap="closeExpenseModal">å–æ¶ˆ</view>
      <view class="action-btn confirm" bindtap="confirmExpense">ç¡®è®¤æ”¯å‡º</view>
    </view>
  </view>
</view>

<view class="modal-mask {{showTransferModal ? 'show' : ''}}" wx:if="{{showTransferModal}}" bindtap="closeTransferModal"></view>
<view class="transfer-modal {{showTransferModal ? 'show' : ''}}" wx:if="{{showTransferModal}}">
  <view class="modal-header">
    <text class="modal-title">è½¬è´¦</text>
    <text class="modal-close" bindtap="closeTransferModal">âœ•</text>
  </view>
  <view class="modal-body">
    <view class="transfer-info">
      <view class="info-row">
        <text class="info-label">è½¬å‡ºæ–¹:</text>
        <text class="info-value">{{currentUser}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">æ¥æ”¶æ–¹:</text>
        <text class="info-value">{{targetMember}}</text>
      </view>
    </view>
    <view class="input-section">
      <input class="score-input {{showInputError ? 'error' : ''}}" type="digit" placeholder="è¯·è¾“å…¥ç§¯åˆ†ï¼ˆæ­£æ•´æ•°ï¼‰" value="{{transferAmount}}" bindinput="onTransferAmountInput" />
      <text class="error-tip" wx:if="{{showInputError}}">ä»…æ”¯æŒæ­£æ•´æ•°ç§¯åˆ†</text>
    </view>
    <view class="modal-actions">
      <view class="action-btn cancel" bindtap="closeTransferModal">å–æ¶ˆ</view>
      <view class="action-btn confirm" bindtap="confirmTransfer">ç¡®è®¤è½¬è´¦</view>
    </view>
  </view>
</view>

<view class="modal-mask {{showPrizeModal ? 'show' : ''}}" wx:if="{{showPrizeModal}}" bindtap="closePrizeModal"></view>
<view class="prize-modal {{showPrizeModal ? 'show' : ''}}" wx:if="{{showPrizeModal}}">
  <view class="modal-header">
    <text class="modal-title">è½¬å…¥å¥–æ± </text>
    <text class="modal-close" bindtap="closePrizeModal">âœ•</text>
  </view>
  <view class="modal-body">
    <view class="prize-input-info">
      <text class="info-label">æ“ä½œç©å®¶:</text>
      <text class="info-value">{{currentUser}}</text>
    </view>
    <view class="input-section">
      <input class="score-input {{showInputError ? 'error' : ''}}" type="digit" placeholder="è¯·è¾“å…¥ç§¯åˆ†ï¼ˆæ­£æ•´æ•°ï¼‰" value="{{prizeAmount}}" bindinput="onPrizeAmountInput" />
      <text class="error-tip" wx:if="{{showInputError}}">ä»…æ”¯æŒæ­£æ•´æ•°ç§¯åˆ†</text>
    </view>
    <view class="modal-actions">
      <view class="action-btn cancel" bindtap="closePrizeModal">å–æ¶ˆ</view>
      <view class="action-btn confirm" bindtap="confirmPrizeTransfer">ç¡®è®¤è½¬å…¥</view>
    </view>
  </view>
</view>

<view class="modal-mask {{showReceiveModal ? 'show' : ''}}" wx:if="{{showReceiveModal}}" bindtap="closeReceiveModal"></view>
<view class="confirm-modal {{showReceiveModal ? 'show' : ''}}" wx:if="{{showReceiveModal}}">
  <view class="modal-header">
    <text class="modal-title">ç¡®è®¤æ”¶å–</text>
    <text class="modal-close" bindtap="closeReceiveModal">âœ•</text>
  </view>
  <view class="modal-body">
    <view class="confirm-text">ç¡®è®¤æ”¶å–å¥–æ± å…¨éƒ¨ã€{{room.prizePool.total}}ã€‘ç§¯åˆ†ï¼Ÿ</view>
    <view class="confirm-sub">æ”¶å–åå¥–æ± æ¸…ç©º</view>
    <view class="modal-actions">
      <view class="action-btn cancel" bindtap="closeReceiveModal">å–æ¶ˆ</view>
      <view class="action-btn confirm" bindtap="confirmReceive">ç¡®è®¤æ”¶å–</view>
    </view>
  </view>
</view>

<view class="modal-mask {{showTipModal ? 'show' : ''}}" wx:if="{{showTipModal}}"></view>
<view class="tip-modal {{showTipModal ? 'show' : ''}}" wx:if="{{showTipModal}}">
  <view class="tip-content">
    <text class="tip-text">{{tipText}}</text>
  </view>
</view>

<view class="modal-mask {{showSettleConfirm ? 'show' : ''}}" wx:if="{{showSettleConfirm}}" bindtap="closeSettleConfirm"></view>
<view class="confirm-modal {{showSettleConfirm ? 'show' : ''}}" wx:if="{{showSettleConfirm}}">
  <view class="modal-header">
    <text class="modal-title">ç¡®è®¤ç»“ç®—</text>
    <text class="modal-close" bindtap="closeSettleConfirm">âœ•</text>
  </view>
  <view class="modal-body">
    <view class="confirm-text">ç¡®è®¤ç»“æŸæœ¬å±€å¹¶ç”Ÿæˆæˆ˜ç»©ï¼Ÿ</view>
    <view class="confirm-sub">ç»“ç®—åæ‰€æœ‰ç§¯åˆ†å°†é‡ç½®ä¸º0</view>
    <view class="modal-actions">
      <view class="action-btn cancel" bindtap="closeSettleConfirm">å–æ¶ˆ</view>
      <view class="action-btn confirm" bindtap="confirmSettle">ç¡®è®¤ç»“ç®—</view>
    </view>
  </view>
</view>

<view class="modal-mask {{showResultModal ? 'show' : ''}}" wx:if="{{showResultModal}}" bindtap="closeResultModal"></view>
<view class="result-modal {{showResultModal ? 'show' : ''}}" wx:if="{{showResultModal}}">
  <view class="modal-header">
    <text class="result-room-name">{{resultData.roomName}}</text>
    <text class="modal-close" bindtap="closeResultModal">âœ•</text>
  </view>
  <view class="modal-body result-body">
    <!-- èµ¢å®¶æ¿å— -->
    <view class="result-section" wx:if="{{resultData.winners.length > 0}}">
      <view class="section-title">
        <view class="title-icon win-icon"></view>
        <text class="title-text">èµ¢å®¶ï¼ˆæ­£ç§¯åˆ†ï¼‰</text>
      </view>
      <view class="bar-chart-container-vertical">
        <view class="chart-item-horizontal" wx:for="{{resultData.winners}}" wx:key="playerName">
          <image class="player-avatar-mini" src="{{item.avatarUrl || '/images/avatar.png'}}"></image>
          <text class="player-name-mini">{{item.playerName}}</text>
          <view class="bar-container">
            <view class="bar win-bar-horizontal" style="width: {{item.barHeight}}px;"></view>
          </view>
          <text class="score-label win-score">{{item.displayScore}}</text>
        </view>
      </view>
    </view>

    <!-- è¾“å®¶æ¿å— -->
    <view class="result-section" wx:if="{{resultData.losers.length > 0}}">
      <view class="section-title">
        <view class="title-icon lose-icon"></view>
        <text class="title-text">è¾“å®¶ï¼ˆè´Ÿç§¯åˆ†ï¼‰</text>
      </view>
      <view class="bar-chart-container-vertical">
        <view class="chart-item-horizontal" wx:for="{{resultData.losers}}" wx:key="playerName">
          <image class="player-avatar-mini" src="{{item.avatarUrl || '/images/avatar.png'}}"></image>
          <text class="player-name-mini">{{item.playerName}}</text>
          <view class="bar-container">
            <view class="bar lose-bar-horizontal" style="width: {{item.barHeight}}px;"></view>
          </view>
          <text class="score-label lose-score">{{item.displayScore}}</text>
        </view>
      </view>
    </view>

    <!-- æ— è¾“èµ¢æç¤º -->
    <view class="no-result-tip" wx:if="{{resultData.winners.length === 0 && resultData.losers.length === 0}}">
      <text class="tip-text">æœ¬å±€æ— è¾“èµ¢</text>
    </view>
    <view class="no-winners-tip" wx:elif="{{resultData.winners.length === 0 && resultData.losers.length > 0}}">
      <text class="tip-text">æœ¬å±€æ— èµ¢å®¶</text>
    </view>
    <view class="no-losers-tip" wx:elif="{{resultData.winners.length > 0 && resultData.losers.length === 0}}">
      <text class="tip-text">æœ¬å±€æ— è¾“å®¶</text>
    </view>

    <view class="result-footer-info">
      <view class="info-item">
        <text class="info-label">ç»“ç®—æ—¶é—´</text>
        <text class="info-value">{{resultData.settlementTime}}</text>
      </view>
      <view class="info-item">
        <text class="info-label">æˆ¿é—´æ¨¡å¼</text>
        <text class="info-value mode-badge result-mode-badge {{resultData.roomMode === 'ä¸‹æ³¨æ¨¡å¼' ? 'bet-mode' : 'normal-mode'}}">{{resultData.roomMode}}</text>
      </view>
      <block wx:if="{{resultData.roomMode === 'ä¸‹æ³¨æ¨¡å¼' && resultData.prizePoolInfo}}">
        <view class="info-item">
          <text class="info-label">å¥–æ± æ€»é¢</text>
          <text class="info-value prize-amount">{{resultData.prizePoolInfo.totalPrizePool}} ç§¯åˆ†</text>
        </view>
        <view class="info-item" wx:if="{{resultData.prizePoolInfo.receiver}}">
          <text class="info-label">æ”¶å–äºº</text>
          <text class="info-value">{{resultData.prizePoolInfo.receiver}}</text>
        </view>
      </block>
    </view>

    <view class="result-actions">
      <view class="action-btn share-btn" bindtap="shareResult">åˆ†äº«</view>
      <view class="action-btn save-btn" bindtap="saveResultToAlbum">ä¿å­˜åˆ°ç›¸å†Œ</view>
    </view>
  </view>

</view>

<canvas type="2d" id="resultCanvas" class="result-canvas-hidden" wx:if="{{showResultModal}}"></canvas>

<view class="all-in-tip {{showAllInTip ? 'show' : ''}}" wx:if="{{showAllInTip}}">
  <text class="tip-content-text">è¯·å…ˆè®¾ç½®all inå€¼</text>
</view>

<view class="modal-mask {{showSettingsModal ? 'show' : ''}}" wx:if="{{showSettingsModal}}" bindtap="closeSettingsModal"></view>
<view class="settings-modal {{showSettingsModal ? 'show' : ''}}" wx:if="{{showSettingsModal}}">
  <view class="modal-header">
    <text class="modal-title">æˆ¿é—´è®¾ç½®</text>
    <text class="modal-close" bindtap="closeSettingsModal">âœ•</text>
  </view>
  <view class="modal-body">
    <view class="setting-item" wx:if="{{room.gameMode === 'bet'}}">
      <view class="setting-label">All Inå€¼è®¾ç½®</view>
      <view class="setting-description">è®¾ç½®å…¨å±€all inæœ€å¤§å€¼ï¼ˆä»…æˆ¿ä¸»å¯è®¾ç½®ï¼‰</view>
      <view class="setting-input-wrapper">
        <input class="setting-input" type="digit" placeholder="è¯·è¾“å…¥æ­£æ•´æ•°" value="{{allInInput}}" bindinput="onAllInInput" />
        <text class="setting-unit">åˆ†</text>
      </view>
    </view>
    <view class="modal-actions">
      <view class="action-btn cancel" bindtap="closeSettingsModal">å–æ¶ˆ</view>
      <view class="action-btn confirm" bindtap="saveSettings">ç¡®è®¤ä¿å­˜</view>
    </view>
  </view>
</view>

<view class="modal-mask {{showQrcode ? 'show' : ''}}" wx:if="{{showQrcode}}" bindtap="hideQrcode"></view>
<view class="qrcode-modal {{showQrcode ? 'show' : ''}}" wx:if="{{showQrcode}}">
  <view class="qrcode-header">
    <text class="qrcode-title">æˆ¿é—´äºŒç»´ç </text>
    <text class="qrcode-close" bindtap="hideQrcode">âœ•</text>
  </view>
  <view class="qrcode-body">
    <view class="room-info-card">
      <image class="room-avatar" src="/images/avatar.png"></image>
      <view class="room-info-text">
        <text class="info-name">{{room.roomName}}</text>
        <text class="info-id">ID: {{room._id}}</text>
      </view>
    </view>
    <canvas type="2d" id="qrcodeCanvas" class="qrcode-canvas"></canvas>
    <text class="qrcode-tip">è¯·ä½¿ç”¨æ‰«ç åŠŸèƒ½æ‰«æäºŒç»´ç åŠ å…¥æˆ¿é—´</text>
    <view class="qrcode-actions">
      <view class="action-btn confirm" bindtap="saveQrcode">ä¿å­˜å›¾ç‰‡</view>
      <view class="action-btn secondary" bindtap="shareQrcode">åˆ†äº«ç»™å¥½å‹</view>
    </view>
  </view>
</view>
