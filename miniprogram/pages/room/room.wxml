<!--pages/room/room.wxml-->
<view class="main-container">
  <view class="left-section">
    <view class="members-section">
      <scroll-view class="members-scroll" scroll-y scroll-with-animation enhanced show-scrollbar="{{false}}">
        <view class="sidebar-list">
          <!-- é‚€è¯·å¥½å‹å¡ç‰‡ -->
          <view class="capsule-card invite-card" bindtap="showQrcode">
            <image class="invite-avatar-img" src="/images/weixin.png"></image>
            <text class="capsule-label">é‚€è¯·</text>
          </view>
          
          <!-- ç©å®¶èƒ¶å›Šå¡ç‰‡ -->
          <view class="capsule-card {{item.openid === room.creator ? 'is-creator' : ''}} {{item.openid === myOpenid ? 'is-me' : ''}}"
                wx:for="{{room.members}}" wx:key="index" bindtap="handleMemberTap" data-index="{{index}}">
            <!-- æˆ¿ä¸»çš‡å†  - å³ä¸Šè§’ -->
            <view class="crown-badge" wx:if="{{item.openid === room.creator}}">ğŸ‘‘</view>
            
            <!-- å¤´åƒ -->
            <image class="capsule-avatar" src="{{item.avatarUrl || '/images/avatar.png'}}"></image>
            
            <!-- æ˜µç§° -->
            <text class="capsule-name">{{item.name}}</text>
            
            <!-- åˆ†æ•°èƒ¶å›Š (0åˆ†éšè—) -->
            <view class="score-capsule {{item.score > 0 ? 'positive' : 'negative'}}" wx:if="{{item.score !== 0}}">
              <text class="score-capsule-text">{{item.score > 0 ? '+' : ''}}{{item.score}}</text>
            </view>
          </view>
          
          <!-- æ·»åŠ æˆå‘˜å¡ç‰‡ï¼ˆè™šçº¿æ¡†ï¼‰ -->
          <view class="capsule-card add-card" wx:if="{{room.status === 'playing'}}" bindtap="addMember">
            <view class="add-icon-wrap">+</view>
            <text class="capsule-label gray">æ·»åŠ </text>
          </view>
        </view>
      </scroll-view>
    </view>

  </view>

  <view class="right-section">
    <!-- ä¸‹æ³¨æ¨¡å¼é¢æ¿ -->
    <view class="bet-panel-wrapper" wx:if="{{room.gameMode === 'bet'}}">
      <!-- å…¬å…±å¥–æ± å¡ç‰‡ -->
      <view class="prize-pool-card-modern" bindtap="transferToPrizePool">
        <!-- ç‚¹å‡»åŒºåŸŸï¼šå¥–è¢‹ã€æ•°å­—ã€æç¤º -->
        <view class="prize-pool-content">
          <!-- å¥–è¢‹å›¾æ ‡ -->
          <view class="prize-icon-wrap">
            <text class="prize-bag-icon">ğŸ’°</text>
          </view>
          <!-- ç§¯åˆ†æ•°å­— -->
          <view class="prize-amount-wrap {{animateAmount ? 'animate' : ''}}">
            <text class="prize-amount-number">{{room.prizePool.total}}</text>
          </view>
          <!-- æç¤ºæ–‡å­— -->
          <text class="prize-pool-hint">ç‚¹å‡»è½¬å…¥ç§¯åˆ†</text>
        </view>
        
        <!-- æ”¶å–çŠ¶æ€æç¤º -->
        <view class="prize-receiver-tip {{room.prizePool.receiver ? 'show' : ''}}">
          ã€{{room.prizePool.receiver}}ã€‘å·²æ”¶å–
        </view>
        
        <!-- æ”¶å–å¥–æ± æŒ‰é’® - åœ¨å¡ç‰‡å†…éƒ¨ï¼Œé˜»æ­¢å†’æ³¡ -->
        <view class="collect-pool-btn {{room.prizePool.receiver ? 'disabled' : ''}}" wx:if="{{room.status === 'playing'}}" catchtap="onCollectPoolTap">
          æ”¶å–å¥–æ± 
        </view>
      </view>

      <!-- æ¸¸æˆæ“ä½œæŒ‰é’® - ç´§è´´å¥–æ± ä¸‹æ–¹ -->
      <view class="game-actions-row" wx:if="{{room.status === 'playing'}}">
        <view class="game-action-btn call {{!canFollow ? 'disabled' : ''}}" bindtap="handleFollow">
          <text class="action-btn-text">è·Ÿ</text>
        </view>
        <view class="game-action-btn pass" bindtap="handlePass">
          <text class="action-btn-text">è¿‡</text>
        </view>
        <view class="game-action-btn allin {{!room.allInValue ? 'disabled' : ''}}" bindtap="handleAllIn">
          <text class="action-btn-text">all in</text>
        </view>
      </view>
    </view>


    <view class="chat-section">
      <scroll-view 
        class="chat-scroll" 
        scroll-y 
        scroll-with-animation 
        scroll-into-view="{{scrollIntoView}}"
        bindscrolltoupper="onScrollToUpper">
        <view class="chat-list">
          <!-- åŠ è½½æ›´å¤šæç¤º -->
          <view 
            wx:if="{{room.records.length > 0 && (loadingMoreText || isLoadingMore)}}" 
            class="load-more-container {{hasMore ? 'clickable' : ''}}" 
            bindtap="onLoadingMoreTap">
            <block wx:if="{{isLoadingMore}}">
              <text class="loading-icon">âŸ³</text>
              <text>åŠ è½½ä¸­...</text>
            </block>
            <block wx:else>
              <text>{{loadingMoreText}}</text>
            </block>
          </view>
          <view id="record-{{index}}" class="chat-message {{item.isMe ? 'mine' : 'others'}} {{item.isSystem ? 'system' : ''}}" wx:for="{{room.records}}" wx:key="index" bindtap="onRecordTap" data-record="{{item}}">
            <!-- æ¶ˆæ¯ç»„ä»¶å®¹å™¨ -->
            <view class="message-component">

              <!-- å¤´åƒå’Œç”¨æˆ·åå®¹å™¨ -->
              <view class="avatar-name-container" wx:if="{{!item.isSystem}}">
                <text class="message-username">{{item.detail.operator}}</text>
                <view class="avatar-container {{room.gameMode === 'bet' ? 'bet-avatar' : ''}}">
                  <image class="single-avatar {{item.isMe ? 'avatar-me' : 'avatar-other'}}" src="{{item.detail.operatorAvatar || '/images/avatar.png'}}"></image>
                </view>
              </view>

              <!-- æ°”æ³¡å’Œæ—¶é—´æˆ³å®¹å™¨ -->
              <view class="bubble-time-container">
                <text class="message-time">{{item.time}}</text>
                <view class="bubble {{item.isMe ? 'mine' : 'others'}} {{item.isSystem ? 'system' : ''}} {{item.isReceive ? 'receive' : ''}}">
                  <text class="message-content {{item.isReceive ? 'receive-text' : ''}}">
                    <block wx:if="{{item.segments}}">
                      <text wx:for="{{item.segments}}" wx:for-item="segment" wx:key="index" class="{{segment.isMe ? 'me' : ''}} {{segment.isAmount ? 'transfer-amount' : ''}}">{{segment.text}}</text>
                    </block>
                    <block wx:else>{{item.processedDescription || item.description}}</block>
                  </text>
                </view>
              </view>

            </view>
          </view>
</view>

<!-- å…¨å±æ‚¬æµ®æ‹–åŠ¨èœå• (Floating Action Button) -->
<movable-area class="fab-area">
  <movable-view 
    class="fab-container"
    direction="all"
    x="{{fabX}}"
    y="{{fabY}}"
    inertia
    friction="2"
    damping="20"
    width="100"
    height="100">
    <!-- å­æŒ‰é’®èœå• -->
    <view class="fab-menu {{fabExpanded ? 'expanded' : ''}}">
      <!-- è®¾ç½®æŒ‰é’® -->
      <view class="fab-sub-btn settings" wx:if="{{isCreator}}" bindtap="openSettingsModal">
        <text class="fab-sub-icon">âš™ï¸</text>
      </view>
      <!-- é€€å‡ºæŒ‰é’® -->
      <view class="fab-sub-btn exit" bindtap="openExitConfirm">
        <text class="fab-sub-icon">ğŸšª</text>
      </view>
    </view>
    <!-- ä¸»æŒ‰é’® -->
    <view class="fab-main" bindtap="toggleFab">
      <text class="fab-main-icon {{fabExpanded ? 'rotated' : ''}}">â˜°</text>
    </view>
  </movable-view>
</movable-area>
      </scroll-view>

      <view class="bottom-actions-container">
        <view class="action-btn expense-btn {{room.status !== 'playing' ? 'disabled' : ''}}" bindtap="handleExpenseBtn" wx:if="{{room.gameMode === 'normal'}}">
          <text class="btn-icon">ğŸ’¸</text>
          <text class="btn-text">æ”¯å‡º</text>
        </view>
        <view class="action-btn settle-btn {{room.status !== 'playing' ? 'disabled' : ''}}" bindtap="handleSettleBtn">
          <text class="btn-icon">ğŸ“‹</text>
          <text class="btn-text">{{room.status === 'playing' ? 'ç»“ç®—' : 'å·²ç»“ç®—'}}</text>
        </view>
      </view>
    </view>
  </view>
</view>

<view class="float-animation-container" wx:if="{{showFloatAnimation}}">
  <text class="float-amount" style="left: {{floatLeft}}px; top: {{floatTop}}px;">+{{floatAmount}}</text>
</view>

<view class="receive-animation-container" wx:if="{{showReceiveAnimation}}">
  <view class="receive-amount-display">
    <text class="receive-amount-text">+{{receiveAmount}}</text>
  </view>

  <view class="confetti-item" wx:for="{{confettiList}}" wx:key="id"
    style="left: {{item.left}}px; top: {{item.top}}px; background: {{item.color}}; width: {{item.width}}px; height: {{item.height}}px; animation-duration: {{item.duration}}ms; animation-delay: {{item.delay}}ms;">
  </view>
  <view class="coin-item" wx:for="{{coinList}}" wx:key="id"
    style="left: {{item.left}}px; top: {{item.top}}px; width: {{item.size}}px; height: {{item.size}}px; animation-duration: {{item.duration}}ms; animation-delay: {{item.delay}}ms;">
    <view class="coin-inner">
      <text class="coin-text">ğŸ’°</text>
    </view>
  </view>
</view>

<view class="modal-mask {{showExpenseModal ? 'show' : ''}}" wx:if="{{showExpenseModal}}" bindtap="closeExpenseModal"></view>
<view class="expense-modal {{showExpenseModal ? 'show' : ''}}" wx:if="{{showExpenseModal}}">
  <view class="modal-header">
    <text class="modal-title">æ‰¹é‡æ”¯å‡º</text>
    <text class="modal-close" bindtap="closeExpenseModal">âœ•</text>
  </view>
  <view class="modal-body">
    <view class="expense-info">
      <view class="info-row">
        <text class="info-label">æ”¯å‡ºæ–¹:</text>
        <text class="info-value">{{currentUser}}</text>
      </view>
    </view>
    <view class="expense-list">
      <view class="expense-item" wx:for="{{room.members}}" wx:key="name" wx:if="{{item.openid !== myOpenid}}">
        <view class="player-info">
          <image class="player-avatar" src="{{item.avatarUrl || '/images/avatar.png'}}"></image>
          <text class="player-name">{{item.name}}</text>
        </view>
        <view class="input-section">
          <input class="score-input" type="digit" placeholder="0" value="{{expenseAmounts[item.name] || ''}}" data-name="{{item.name}}" bindinput="onExpenseAmountInput" />
          <text class="score-unit">ç§¯åˆ†</text>
        </view>
      </view>
    </view>
    <view class="expense-total">
      <text class="total-label">æ€»è®¡æ”¯å‡º:</text>
      <text class="total-value">{{expenseTotal || 0}} ç§¯åˆ†</text>
    </view>
    <view class="modal-actions">
      <view class="action-btn cancel" bindtap="closeExpenseModal">å–æ¶ˆ</view>
      <view class="action-btn confirm" bindtap="confirmExpense">ç¡®è®¤æ”¯å‡º</view>
    </view>
  </view>
</view>

<view class="modal-mask {{showTransferModal ? 'show' : ''}}" wx:if="{{showTransferModal}}" bindtap="closeTransferModal"></view>
<view class="transfer-modal {{showTransferModal ? 'show' : ''}}" wx:if="{{showTransferModal}}">
  <view class="modal-header">
    <text class="modal-title">è½¬è´¦</text>
    <text class="modal-close" bindtap="closeTransferModal">âœ•</text>
  </view>
  <view class="modal-body">
    <view class="transfer-info">
      <view class="info-row">
        <text class="info-label">è½¬å‡ºæ–¹:</text>
        <text class="info-value">{{currentUser}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">æ¥æ”¶æ–¹:</text>
        <text class="info-value">{{targetMember}}</text>
      </view>
    </view>
    <view class="input-section">
      <input class="score-input {{showInputError ? 'error' : ''}}" type="digit" placeholder="è¯·è¾“å…¥ç§¯åˆ†ï¼ˆæ­£æ•´æ•°ï¼‰" value="{{transferAmount}}" bindinput="onTransferAmountInput" />
      <text class="error-tip" wx:if="{{showInputError}}">ä»…æ”¯æŒæ­£æ•´æ•°ç§¯åˆ†</text>
    </view>
    <view class="modal-actions">
<view class="action-btn cancel {{transferSubmitting ? 'disabled' : ''}}" bindtap="{{transferSubmitting ? '' : 'closeTransferModal'}}">å–æ¶ˆ</view>
      <view class="action-btn confirm {{transferSubmitting ? 'disabled' : ''}}" bindtap="{{transferSubmitting ? '' : 'confirmTransfer'}}">
        {{transferSubmitting ? 'è½¬è´¦ä¸­...' : 'ç¡®è®¤è½¬è´¦'}}
      </view>
    </view>
  </view>
</view>

<view class="modal-mask {{showPrizeModal ? 'show' : ''}}" wx:if="{{showPrizeModal}}" bindtap="closePrizeModal"></view>
<view class="prize-modal {{showPrizeModal ? 'show' : ''}}" wx:if="{{showPrizeModal}}">
  <view class="modal-header">
    <text class="modal-title">è½¬å…¥å¥–æ± </text>
    <text class="modal-close" bindtap="closePrizeModal">âœ•</text>
  </view>
  <view class="modal-body">
    <view class="prize-input-info">
      <text class="info-label">æ“ä½œç©å®¶:</text>
      <text class="info-value">{{currentUser}}</text>
    </view>
    <view class="input-section">
      <input class="score-input {{showInputError ? 'error' : ''}}" type="digit" placeholder="è¯·è¾“å…¥ç§¯åˆ†ï¼ˆæ­£æ•´æ•°ï¼‰" value="{{prizeAmount}}" bindinput="onPrizeAmountInput" />
      <text class="error-tip" wx:if="{{showInputError}}">ä»…æ”¯æŒæ­£æ•´æ•°ç§¯åˆ†</text>
    </view>
    <view class="modal-actions">
      <view class="action-btn cancel" bindtap="closePrizeModal">å–æ¶ˆ</view>
      <view class="action-btn confirm" bindtap="confirmPrizeTransfer">ç¡®è®¤è½¬å…¥</view>
    </view>
  </view>
</view>

<view class="modal-mask {{showReceiveModal ? 'show' : ''}}" wx:if="{{showReceiveModal}}" bindtap="closeReceiveModal"></view>
<view class="confirm-modal {{showReceiveModal ? 'show' : ''}}" wx:if="{{showReceiveModal}}">
  <view class="modal-header">
    <text class="modal-title">ç¡®è®¤æ”¶å–</text>
    <text class="modal-close" bindtap="closeReceiveModal">âœ•</text>
  </view>
  <view class="modal-body">
    <view class="confirm-text">ç¡®è®¤æ”¶å–å¥–æ± å…¨éƒ¨ã€{{room.prizePool.total}}ã€‘ç§¯åˆ†ï¼Ÿ</view>
    <view class="confirm-sub">æ”¶å–åå¥–æ± æ¸…ç©º</view>
    <view class="modal-actions">
      <view class="action-btn cancel" bindtap="closeReceiveModal">å–æ¶ˆ</view>
      <view class="action-btn confirm" bindtap="confirmReceive">ç¡®è®¤æ”¶å–</view>
    </view>
  </view>
</view>

<view class="modal-mask {{showTipModal ? 'show' : ''}}" wx:if="{{showTipModal}}"></view>
<view class="tip-modal {{showTipModal ? 'show' : ''}}" wx:if="{{showTipModal}}">
  <view class="tip-content">
    <text class="tip-text">{{tipText}}</text>
  </view>
</view>

<view class="modal-mask {{showSettleConfirm ? 'show' : ''}}" wx:if="{{showSettleConfirm}}" bindtap="closeSettleConfirm"></view>
<view class="confirm-modal {{showSettleConfirm ? 'show' : ''}}" wx:if="{{showSettleConfirm}}">
  <view class="modal-header">
    <text class="modal-title">ç¡®è®¤ç»“ç®—</text>
    <text class="modal-close" bindtap="closeSettleConfirm">âœ•</text>
  </view>
  <view class="modal-body">
    <view class="confirm-text">ç¡®è®¤ç»“æŸæœ¬å±€å¹¶ç”Ÿæˆæˆ˜ç»©ï¼Ÿ</view>
    <view class="confirm-sub">ç»“ç®—åæ‰€æœ‰ç§¯åˆ†å°†é‡ç½®ä¸º0</view>
    <view class="modal-actions">
      <view class="action-btn cancel" bindtap="closeSettleConfirm">å–æ¶ˆ</view>
      <view class="action-btn confirm" bindtap="confirmSettle">ç¡®è®¤ç»“ç®—</view>
    </view>
  </view>
</view>

<view class="modal-mask {{showResultModal ? 'show' : ''}}" wx:if="{{showResultModal}}" bindtap="closeResultModal"></view>
<view class="result-modal {{showResultModal ? 'show' : ''}}" wx:if="{{showResultModal}}">
  <view class="modal-header">
    <text class="result-room-name">{{resultData.roomName}}</text>
    <text class="modal-close" bindtap="closeResultModal">âœ•</text>
  </view>
  <scroll-view class="result-scroll-view" scroll-y="true" scroll-with-animation>
    <view class="modal-body result-body">
      <!-- ç»“ç®—ä¿¡æ¯åŒºåŸŸï¼ˆç½®é¡¶ï¼‰ -->
      <view class="settlement-info-section">
        <view class="info-header">
          <text class="info-title">ç»“ç®—ä¿¡æ¯</text>
        </view>
        <view class="info-content" wx:if="{{resultData}}">
          <view class="info-row">
            <text class="info-label">æˆ¿é—´å</text>
            <text class="info-value bold-text">{{resultData.roomName}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">ç»“ç®—æ—¶é—´</text>
            <text class="info-value">{{resultData.settlementTime}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æˆ¿é—´æ¨¡å¼</text>
            <text class="info-value mode-badge result-mode-badge {{resultData.roomMode === 'ä¸‹æ³¨æ¨¡å¼' ? 'bet-mode' : 'normal-mode'}}">{{resultData.roomMode}}</text>
          </view>
          <view class="info-row" wx:if="{{resultData.creator}}">
            <text class="info-label">ç»“ç®—è§¦å‘äºº</text>
            <text class="info-value">{{resultData.creator}}</text>
          </view>
          <block wx:if="{{resultData.roomMode === 'ä¸‹æ³¨æ¨¡å¼' && resultData.prizePoolInfo}}">
            <view class="info-row">
              <text class="info-label">å¥–æ± æ€»é¢</text>
              <text class="info-value prize-amount">{{resultData.prizePoolInfo.totalPrizePool}} ç§¯åˆ†</text>
            </view>
            <view class="info-row" wx:if="{{resultData.prizePoolInfo.receiver}}">
              <text class="info-label">æ”¶å–äºº</text>
              <text class="info-value">{{resultData.prizePoolInfo.receiver}}</text>
            </view>
          </block>
        </view>
        <view class="no-info-tip" wx:elif="{{!resultData}}">
          <text class="tip-text">æš‚æ— ç»“ç®—äº‹ä»¶ä¿¡æ¯</text>
        </view>
      </view>

      <!-- åˆ†éš”çº¿ -->
      <view class="section-divider"></view>

      <!-- èµ¢å®¶æ¿å— -->
      <view class="result-section" wx:if="{{resultData.winners.length > 0}}">
        <view class="section-title">
          <view class="title-icon win-icon"></view>
          <text class="title-text">èµ¢å®¶</text>
        </view>
        <view class="bar-chart-container-vertical">
          <view class="chart-item-horizontal" wx:for="{{resultData.winners}}" wx:key="playerName">
            <image class="player-avatar-mini" src="{{item.avatarUrl || '/images/avatar.png'}}"></image>
            <text class="player-name-mini">{{item.playerName}}</text>
            <view class="bar-container">
              <view class="bar win-bar-horizontal" style="width: {{item.barHeight}}px;"></view>
            </view>
            <text class="score-label win-score">{{item.displayScore}}</text>
          </view>
        </view>
      </view>

      <!-- è¾“å®¶æ¿å— -->
      <view class="result-section" wx:if="{{resultData.losers.length > 0}}">
        <view class="section-title">
          <view class="title-icon lose-icon"></view>
          <text class="title-text">è¾“å®¶</text>
        </view>
        <view class="bar-chart-container-vertical">
          <view class="chart-item-horizontal" wx:for="{{resultData.losers}}" wx:key="playerName">
            <image class="player-avatar-mini" src="{{item.avatarUrl || '/images/avatar.png'}}"></image>
            <text class="player-name-mini">{{item.playerName}}</text>
            <view class="bar-container">
              <view class="bar lose-bar-horizontal" style="width: {{item.barHeight}}px;"></view>
            </view>
            <text class="score-label lose-score">{{item.displayScore}}</text>
          </view>
        </view>
      </view>

      <!-- æ— è¾“èµ¢æç¤º -->
      <view class="no-result-tip" wx:if="{{resultData.winners.length === 0 && resultData.losers.length === 0}}">
        <text class="tip-text">æœ¬å±€æ— è¾“èµ¢</text>
      </view>
      <view class="no-winners-tip" wx:elif="{{resultData.winners.length === 0 && resultData.losers.length > 0}}">
        <text class="tip-text">æœ¬å±€æ— èµ¢å®¶</text>
      </view>
      <view class="no-losers-tip" wx:elif="{{resultData.winners.length > 0 && resultData.losers.length === 0}}">
        <text class="tip-text">æœ¬å±€æ— è¾“å®¶</text>
      </view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨æŒ‰é’®åŒºåŸŸï¼ˆå›ºå®šï¼Œä¸æ»šåŠ¨ï¼‰ -->
  <view class="result-actions">
    <view class="action-btn share-btn" bindtap="shareResult">åˆ†äº«</view>
    <view class="action-btn save-btn" bindtap="saveResultToAlbum">ä¿å­˜åˆ°ç›¸å†Œ</view>
  </view>
</view>

<canvas type="2d" id="resultCanvas" class="result-canvas-hidden" wx:if="{{showResultModal}}"></canvas>

<view class="all-in-tip {{showAllInTip ? 'show' : ''}}" wx:if="{{showAllInTip}}">
  <text class="tip-content-text">è¯·å…ˆè®¾ç½®all inå€¼</text>
</view>

<view class="modal-mask {{showExitConfirm ? 'show' : ''}}" wx:if="{{showExitConfirm}}" bindtap="closeExitConfirm"></view>
<view class="confirm-modal {{showExitConfirm ? 'show' : ''}}" wx:if="{{showExitConfirm}}">
  <view class="modal-header">
    <text class="modal-title">ç¡®è®¤é€€å‡º</text>
    <text class="modal-close" bindtap="closeExitConfirm">âœ•</text>
  </view>
  <view class="modal-body">
    <view class="confirm-text">ç¡®è®¤é€€å‡ºæœ¬æˆ¿é—´ï¼Ÿ</view>
    <view class="confirm-sub">é€€å‡ºåéœ€è¦é‡æ–°æ‰«ç æ‰èƒ½åŠ å…¥</view>
    <view class="modal-actions">
      <view class="action-btn cancel" bindtap="closeExitConfirm">å–æ¶ˆ</view>
      <view class="action-btn confirm" bindtap="confirmExit">ç¡®è®¤é€€å‡º</view>
    </view>
  </view>
</view>

<view class="modal-mask {{showSettingsModal ? 'show' : ''}}" wx:if="{{showSettingsModal}}" bindtap="closeSettingsModal"></view>
<view class="settings-modal {{showSettingsModal ? 'show' : ''}}" wx:if="{{showSettingsModal}}">
  <view class="modal-header">
    <text class="modal-title">æˆ¿é—´è®¾ç½®</text>
    <text class="modal-close" bindtap="closeSettingsModal">âœ•</text>
  </view>
  <view class="modal-body">
    <view class="setting-item" wx:if="{{room.gameMode === 'bet'}}">
      <view class="setting-label">All Inå€¼è®¾ç½®</view>
      <view class="setting-description">è®¾ç½®å…¨å±€all inæœ€å¤§å€¼ï¼ˆä»…æˆ¿ä¸»å¯è®¾ç½®ï¼‰</view>
      <view class="setting-input-wrapper">
        <input class="setting-input" type="digit" placeholder="è¯·è¾“å…¥æ­£æ•´æ•°" value="{{allInInput}}" bindinput="onAllInInput" />
        <text class="setting-unit">åˆ†</text>
      </view>
    </view>
    <view class="modal-actions">
      <view class="action-btn cancel" bindtap="closeSettingsModal">å–æ¶ˆ</view>
      <view class="action-btn confirm" bindtap="saveSettings">ç¡®è®¤ä¿å­˜</view>
    </view>
  </view>
</view>

<view class="modal-mask {{showQrcode ? 'show' : ''}}" wx:if="{{showQrcode}}" bindtap="hideQrcode"></view>
<view class="qrcode-modal {{showQrcode ? 'show' : ''}}" wx:if="{{showQrcode}}">
  <view class="qrcode-header">
    <text class="qrcode-title">é‚€è¯·å¥½å‹</text>
    <text class="qrcode-close" bindtap="hideQrcode">âœ•</text>
  </view>
  <view class="qrcode-body">
    <view class="room-info-card">
      <text class="info-name">{{room.roomName}}</text>
      <text class="info-id">æˆ¿é—´å·: {{room._id}}</text>
    </view>
    
    <!-- å°ç¨‹åºç å›¾ç‰‡ -->
    <view class="qrcode-image-wrapper">
      <image 
        class="qrcode-image" 
        src="{{qrCodeTempUrl}}"
        mode="aspectFit"
        wx:if="{{qrCodeFileID && !qrCodeError}}"
      ></image>
      
      <!-- ç”Ÿæˆä¸­çŠ¶æ€ -->
      <view class="qrcode-loading" wx:if="{{isGeneratingQR && !qrCodeFileID}}">
        <text class="loading-text">äºŒç»´ç ç”Ÿæˆä¸­...</text>
      </view>
      
      <!-- ç”Ÿæˆå¤±è´¥çŠ¶æ€ -->
      <view class="qrcode-error" wx:if="{{qrCodeError}}" bindtap="getRoomQRCode">
        <text class="error-text">äºŒç»´ç ç”Ÿæˆå¤±è´¥</text>
        <text class="retry-text">ç‚¹å‡»é‡è¯•</text>
      </view>
    </view>
    
    <text class="qrcode-tip" wx:if="{{!qrCodeError}}">å¾®ä¿¡æ‰«ç å³å¯åŠ å…¥æˆ¿é—´</text>
    
    <view class="qrcode-actions">
      <view class="action-btn confirm {{!qrCodeFileID || qrCodeError ? 'disabled' : ''}}" bindtap="{{qrCodeFileID && !qrCodeError ? 'saveQrcode' : ''}}">ä¿å­˜å›¾ç‰‡</view>
      <button class="action-btn secondary share-btn" open-type="share">åˆ†äº«ç»™å¥½å‹</button>
    </view>
  </view>
</view>

<!-- ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯å¼¹çª— -->
<view class="modal-mask {{showEditProfileModal ? 'show' : ''}}" wx:if="{{showEditProfileModal}}" bindtap="closeEditProfileModal"></view>
<view class="edit-profile-modal {{showEditProfileModal ? 'show' : ''}}" wx:if="{{showEditProfileModal}}">
  <view class="edit-profile-header">
    <text class="edit-profile-title">ç¼–è¾‘èµ„æ–™</text>
    <text class="edit-profile-close" bindtap="closeEditProfileModal">âœ•</text>
  </view>
  <view class="edit-profile-body">
    <!-- å¤´åƒç¼–è¾‘ -->
    <view class="avatar-edit-section">
      <button class="avatar-edit-btn" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
        <view class="edit-avatar-wrapper">
          <image class="edit-avatar-img" src="{{editProfile.avatarUrl || '/images/avatar.png'}}" mode="aspectFill"></image>
          <view class="avatar-edit-icon">
            <text class="edit-icon-text">âœï¸</text>
          </view>
        </view>
      </button>
    </view>
    
    <!-- æ˜µç§°ç¼–è¾‘ -->
    <view class="nickname-edit-section">
      <text class="edit-label">æ˜µç§°</text>
      <input 
        class="nickname-input" 
        type="nickname" 
        placeholder="è¯·è¾“å…¥æ˜µç§°" 
        value="{{editProfile.nickname}}"
        bindinput="onNicknameInput"
        bindblur="onNicknameConfirm"
      />
    </view>
    
    <!-- ä¿å­˜æŒ‰é’® -->
    <view class="edit-profile-actions">
      <view class="action-btn save-profile-btn {{isSavingProfile ? 'disabled' : ''}}" bindtap="{{isSavingProfile ? '' : 'saveProfile'}}">
        <text class="save-btn-text">{{isSavingProfile ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}}</text>
      </view>
    </view>
  </view>
</view>
