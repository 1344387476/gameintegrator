# 测试计划 - 打牌记账小程序

## 项目概述
- **功能**：实时消息推送、分页加载、本地优先显示
- **测试日期**：2026-01-30
- **版本**：v2.0
- **测试环境**：微信开发者工具 + 真机测试

---

## 一、云函数部署清单

### 1.1 gameLogic 云函数
- [ ] 右键 `cloudfunctions/gameLogic` → 上传并部署：云端安装依赖
- [ ] 验证部署成功：查看云开发控制台

### 1.2 roomFunctions 云函数
- [ ] 右键 `cloudfunctions/roomFunctions` → 上传并部署：云端安装依赖
- [ ] 验证部署成功：查看云开发控制台

---

## 二、单用户功能测试

### 2.1 基础功能
- [ ] 进入房间页面正常加载
- [ ] 房间信息显示正确（名称、模式、成员列表）
- [ ] 成员头像显示正确（有头像显示头像，无头像显示默认头像）

### 2.2 消息加载
- [ ] 初始加载显示最近32条消息
- [ ] 消息列表按时间降序排列（最新消息在顶部）
- [ ] 消息时间格式正确（今天：HH:MM，非今天：YYYY-MM-DD HH:MM）

### 2.3 消息显示
- [ ] 欢迎消息显示正确（包含房间名称）
- [ ] 转账消息显示正确（发送者、接收者、金额）
- [ ] 下注消息显示正确（操作者、金额）
- [ ] All-in 消息显示正确（操作者、金额）
- [ ] 收取奖池消息显示正确（操作者、金额）
- [ ] "过"消息显示正确（操作者）

### 2.4 头像显示
- [ ] 转账消息：发送者和接收者头像显示正确
- [ ] 下注/All-in/收取奖池：操作者头像显示正确
- [ ] 无头像用户：显示默认头像（/images/avatar.png）

### 2.5 本地优先显示
- [ ] 执行转账操作：消息立即显示在列表顶部（无需等待watch）
- [ ] 执行下注操作：消息立即显示在列表顶部
- [ ] 执行All-in操作：消息立即显示在列表顶部
- [ ] 执行收取奖池：消息立即显示在列表顶部
- [ ] 执行"过"操作：消息立即显示在列表顶部

### 2.6 分页加载
- [ ] 初始加载32条消息
- [ ] 上拉到顶部：显示"加载中..."提示
- [ ] 加载完成：显示新的32条消息
- [ ] 重复上拉到顶部：继续加载
- [ ] 加载达到100条：显示"最多显示100条历史消息"
- [ ] 加载失败：显示"加载失败，点击重试"
- [ ] 点击失败提示：重新加载

### 2.7 滚动行为
- [ ] 进入房间：自动滚动到底部显示最新消息
- [ ] 新消息到达：自动滚动到底部
- [ ] 加载更多后：保持用户当前滚动位置

### 2.8 消息去重
- [ ] 本地添加的消息，后续从数据库加载后自动去重
- [ ] 同一条消息不会重复显示

---

## 三、实时推送测试（需要多用户）

### 3.1 Watch监听测试
- [ ] 用户A创建房间
- [ ] 用户B扫码加入房间
- [ ] 用户A和B都能看到欢迎消息
- [ ] 欢迎消息显示正确，头像正确

### 3.2 转账消息同步
- [ ] 用户A向用户B转账100分
- [ ] 用户A立即看到本地消息（优先显示）
- [ ] 用户B通过watch收到新消息
- [ ] 双方消息内容一致
- [ ] 双方头像显示正确

### 3.3 批量转账同步
- [ ] 用户A执行支出（批量转账）
- [ ] 用户A立即看到多条本地消息
- [ ] 其他用户通过watch收到多条新消息
- [ ] 所有用户看到的消息顺序一致

### 3.4 下注模式消息同步
- [ ] 用户A转入奖池50分
- [ ] 用户A立即看到本地消息
- [ ] 其他用户通过watch收到新消息
- [ ] 用户B跟注50分
- [ ] 所有用户看到两条下注消息
- [ ] 用户A All-in 100分
- [ ] 所有用户看到All-in消息
- [ ] 用户C收取奖池
- [ ] 所有用户看到收取奖池消息

### 3.5 "过"消息同步
- [ ] 用户A点击"过"
- [ ] 用户A立即看到本地消息
- [ ] 其他用户通过watch收到"过"消息

### 3.6 多用户并发操作
- [ ] 多个用户同时转账
- [ ] 所有消息都正确显示
- [ ] 消息顺序按时间排序正确

---

## 四、异常场景测试

### 4.1 Watch连接异常
- [ ] Watch连接失败：自动重试（第1次）
- [ ] 重试1次失败：自动重试（第2次，延迟2秒）
- [ ] 重试2次失败：自动重试（第3次，延迟4秒）
- [ ] 重试3次失败：切换到轮询模式（3秒一次）
- [ ] 轮询模式下：消息正常刷新

### 4.2 网络异常
- [ ] 断网后重连：Watch自动重新建立
- [ ] 断网期间操作：本地消息正常显示
- [ ] 重连后：同步历史消息，去重处理

### 4.3 云函数异常
- [ ] 云函数调用失败：显示错误提示
- [ ] 本地消息不添加（云函数失败不添加本地消息）
- [ ] 用户可以重试操作

### 4.4 头像加载异常
- [ ] 头像URL无效：显示默认头像
- [ ] 用户无头像：显示默认头像
- [ ] 历史消息无头像：从room.members查找，仍无则显示默认头像

---

## 五、性能测试

### 5.1 消息加载性能
- [ ] 初始加载32条消息：时间 < 500ms
- [ ] 加载更多32条消息：时间 < 300ms
- [ ] 加载达到100条：时间 < 500ms

### 5.2 滚动性能
- [ ] 滚动100条消息列表：流畅无卡顿
- [ ] 快速滚动：无白屏或闪烁

### 5.3 实时推送性能
- [ ] Watch推送新消息：延迟 < 1秒
- [ ] 本地消息显示：延迟 < 100ms

---

## 六、兼容性测试

### 6.1 设备兼容性
- [ ] iPhone（iOS 14+）
- [ ] Android（Android 8+）
- [ ] 不同屏幕尺寸：布局正常

### 6.2 微信版本兼容性
- [ ] 微信 8.0.0+
- [ ] 微信云开发SDK兼容性

---

## 七、数据库验证

### 7.1 messages集合验证
- [ ] 每条消息包含字段：`roomId`, `fromOpenid`, `fromNickname`, `fromAvatar`, `content`, `toOpenid`, `toNickname`, `toAvatar`, `timestamp`, `messageType`
- [ ] 头像字段不为空（无头像时为空字符串）
- [ ] 欢迎消息：`messageType: 'welcome'`

### 7.2 历史消息兼容性
- [ ] 旧消息（无头像字段）：从room.members查找头像
- [ ] 查找失败：显示默认头像

---

## 八、用户体验测试

### 8.1 加载提示
- [ ] "上拉查看更多历史消息"：清晰易懂
- [ ] "加载中..."：显示旋转动画
- [ ] "已显示全部消息"：提示明确
- [ ] "最多显示100条历史消息"：提示明确
- [ ] "加载失败，点击重试"：可交互

### 8.2 消息显示
- [ ] 当前用户名显示为"我"：高亮显示
- [ ] 金额数字高亮：便于查看
- [ ] 系统消息样式：区分明显

### 8.3 交互反馈
- [ ] 点击操作：立即响应
- [ ] 操作失败：显示错误提示
- [ ] 成功操作：自动滚动到最新消息

---

## 九、回归测试

### 9.1 普通模式
- [ ] 创建房间
- [ ] 成员加入
- [ ] 转账功能
- [ ] 支出功能（批量转账）
- [ ] 结算功能
- [ ] 退出房间

### 9.2 下注模式
- [ ] 创建下注模式房间
- [ ] 转入奖池
- [ ] All-in
- [ ] 跟注
- [ ] 跳过回合
- [ ] 收取奖池

### 9.3 房间管理
- [ ] 修改房间设置
- [ ] 添加成员
- [ ] 生成二维码
- [ ] 结算战绩
- [ ] 保存战绩图片

---

## 十、边界值测试

### 10.1 消息数量边界
- [ ] 0条消息：空状态正常
- [ ] 32条消息：正常显示
- [ ] 64条消息：正常显示
- [ ] 96条消息：正常显示
- [ ] 100条消息：正常显示
- [ ] 超过100条：只显示100条

### 10.2 用户数量边界
- [ ] 1人房间：正常
- [ ] 4人房间：正常
- [ ] 8人房间：正常

### 10.3 积分边界
- [ ] 0分：正常显示
- [ ] 负分：正常显示
- [ ] 大额积分（>999999）：正常显示，积分滚动

---

## 十一、已知限制说明

### 11.1 连接数限制
- **说明**：微信云开发watch有连接数限制（约100并发）
- **影响**：如果同时在线用户过多，部分用户可能无法建立watch连接
- **解决方案**：自动降级到轮询模式（3秒刷新一次）

### 11.2 消息数量限制
- **说明**：最多显示100条历史消息
- **原因**：性能优化和用户体验平衡
- **影响**：超过100条的历史消息无法查看

### 11.3 单用户测试限制
- **说明**：当前无法进行多用户实时同步测试
- **建议**：小程序上线后邀请真实用户进行多用户测试

---

## 十二、测试报告模板

| 测试项 | 测试结果 | 问题描述 | 优先级 | 状态 |
|--------|---------|---------|--------|------|
| 示例：云函数部署 | ✅ 通过 | - | - | 已完成 |

### 优先级说明
- **P0**：阻塞问题，必须修复
- **P1**：重要问题，尽快修复
- **P2**：一般问题，可以延后
- **P3**：优化建议，非必须

### 状态说明
- **待测试**：尚未测试
- **进行中**：正在测试
- **已完成**：测试通过
- **已阻塞**：测试失败

---

## 十三、发布前检查清单

### 13.1 功能检查
- [ ] 所有单用户功能测试通过
- [ ] 云函数部署成功
- [ ] 本地优先显示正常
- [ ] 分页加载正常
- [ ] 消息去重正常

### 13.2 性能检查
- [ ] 消息加载性能达标
- [ ] 滚动性能达标
- [ ] 实时推送性能达标

### 13.3 代码检查
- [ ] 代码符合AGENTS.md规范
- [ ] 无console.log调试代码
- [ ] 无TODO未完成项
- [ ] 错误处理完善

### 13.4 文档检查
- [ ] AGENTS.md更新完整
- [ ] 代码注释清晰
- [ ] 测试计划文档完整

---

## 十四、发布后测试计划

### 14.1 真实用户测试
- [ ] 邀请3-5名好友测试多用户功能
- [ ] 测试Watch实时推送
- [ ] 测试并发操作
- [ ] 收集用户反馈

### 14.2 监控与优化
- [ ] 监控云函数调用成功率
- [ ] 监控Watch连接稳定性
- [ ] 监控消息加载性能
- [ ] 根据数据优化参数

### 14.3 反馈收集
- [ ] 建立用户反馈渠道
- [ ] 记录用户遇到的问题
- [ ] 优先处理高频问题
- [ ] 规划下一版本优化

---

## 附录

### A. 测试数据准备
- **测试账号A**：用户名"测试A"，头像A
- **测试账号B**：用户名"测试B"，头像B
- **测试账号C**：用户名"测试C"，无头像
- **测试房间**："测试房间001"

### B. 测试工具
- 微信开发者工具
- 云开发控制台
- 微信小程序真机调试

### C. 测试注意事项
1. 测试前确保云函数已部署
2. 测试时保持网络稳定
3. 记录详细的测试日志
4. 截图保存测试结果
5. 问题复现步骤要详细

---

**测试负责人**：Craft
**创建日期**：2026-01-30
**最后更新**：2026-01-30
