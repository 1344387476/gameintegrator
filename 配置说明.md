# 打牌记账小程序配置说明

## 一、服务器上传接口配置

### 1. 服务器接口地址配置

**配置位置：** `miniprogram/pages/room/room.js` 第543行

```javascript
// TODO: 配置服务器接口地址
const serverUrl = 'https://your-server.com/api/settlement';
```

**配置说明：**
- 将 `https://your-server.com/api/settlement` 替换为实际的服务器接口地址
- 接口类型：POST
- 请求头：Content-Type: application/json
- 请求体：战绩数据（JSON格式）

### 2. 服务器接口数据格式

**请求体示例：**

```json
{
  "roomId": "1234567890",
  "roomMode": "普通模式",
  "roomName": "测试房间",
  "settlementTime": "2026-01-16 22:00",
  "creator": "张三",
  "playerList": [
    {
      "playerName": "张三",
      "score": 12,
      "result": "赢",
      "winLose": 12
    },
    {
      "playerName": "李四",
      "score": -8,
      "result": "输",
      "winLose": -8
    }
  ],
  "prizePoolInfo": {
    "totalPrizePool": 88,
    "receiver": "张三",
    "receiveTime": "2026-01-16 22:00"
  },
  "isUploaded": false
}
```

**字段说明：**
- `roomId`: 房间唯一ID
- `roomMode`: 游戏模式（普通模式/下注模式）
- `roomName`: 房间名称
- `settlementTime`: 结算时间
- `creator`: 房主昵称
- `playerList`: 玩家列表
  - `playerName`: 玩家昵称
  - `score`: 玩家积分（正数为赢，负数为输）
  - `result`: 结果（赢/输/平局）
  - `winLose`: 输赢积分
- `prizePoolInfo`: 奖池信息（仅下注模式有此字段）
  - `totalPrizePool`: 奖池总转入金额
  - `receiver`: 收取奖池的玩家
  - `receiveTime`: 收取时间
- `isUploaded`: 是否已上传

## 二、微信小程序权限申请

### 1. 保存到相册权限

**权限名称：** `scope.writePhotosAlbum`

**申请位置：** 微信小程序后台 → 设置 → 接口设置

**申请代码位置：** `miniprogram/pages/room/room.js` 第615-632行

```javascript
wx.getSetting({
  success: (setting) => {
    if (!setting.authSetting['scope.writePhotosAlbum']) {
      wx.authorize({
        scope: 'scope.writePhotosAlbum',
        success: () => {
          this.saveToAlbum(res.tempFilePath);
        },
        fail: () => {
          this.showTip('需要相册权限才能保存图片');
        }
      });
    } else {
      this.saveToAlbum(res.tempFilePath);
    }
  }
});
```

**配置步骤：**
1. 登录微信公众平台（mp.weixin.qq.com）
2. 进入小程序后台
3. 点击「设置」→「接口设置」
4. 找到「保存到相册」权限
5. 点击「开启」并填写申请理由（例如：用户需要保存游戏战绩图片到相册）
6. 提交审核（1-3个工作日）

**注意：**
- 测试阶段可在「开发设置」→「接口设置」中直接开启
- 正式发布需要在「接口设置」中申请并审核通过

### 2. 网络请求权限

**权限名称：** request合法域名

**申请位置：** 微信小程序后台 → 开发 → 开发设置 → 服务器域名

**配置代码位置：** `miniprogram/pages/room/room.js` 第543行

```javascript
wx.request({
  url: serverUrl,  // 需要在后台配置的域名
  method: 'POST',
  data: this.data.resultData,
  ...
});
```

**配置步骤：**
1. 进入「开发」→「开发设置」→「服务器域名」
2. 点击「request合法域名」的「修改」
3. 添加你的服务器域名（如：https://your-server.com）
4. 域名要求：
   - 必须是HTTPS协议
   - 必须备案的域名
   - 不支持IP地址
5. 保存配置

**开发测试：**
- 在微信开发者工具中，点击「详情」→「本地设置」
- 勾选「不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书」
- 这样可以在开发阶段使用任意域名进行测试

## 三、页面跳转配置

### 1. 主页跳转到房间

**跳转代码位置：** `miniprogram/pages/home/home.js` 第128行

```javascript
wx.navigateTo({
  url: `/pages/room/room?roomId=${newRoom._id}`
});
```

**配置说明：**
- 自动跳转到创建的新房间
- 参数 `roomId` 传递房间ID

### 2. 房间跳转到主页

**跳转代码位置：** `miniprogram/pages/room/room.js` 第105行

```javascript
goBack() {
  wx.navigateBack();
}
```

**配置说明：**
- 使用 `wx.navigateBack()` 返回上一页
- 自动返回到主页

### 3. 扫码跳转到房间

**扫码代码位置：** `miniprogram/pages/home/home.js` 第134-180行

```javascript
wx.scanCode({
  scanType: 'qrCode',
  success: (res) => {
    // 解析房间ID
    let roomId = '';
    if (res.result.includes('roomId=')) {
      roomId = res.result.split('roomId=')[1];
    } else {
      roomId = res.result;
    }

    // 跳转到房间
    wx.navigateTo({
      url: `/pages/room/room?roomId=${roomId}`
    });
  }
});
```

**配置说明：**
- 扫描二维码后自动解析房间ID
- 支持两种二维码格式：
  1. 完整URL：`pages/room/room?roomId=xxx`
  2. 纯房间ID：`xxx`

## 四、数据存储说明

### 1. 本地存储

**存储位置：** `wx.getStorageSync` / `wx.setStorageSync`

**存储数据结构：**

```javascript
// 房间列表
{
  "rooms": [
    {
      "_id": "1234567890",
      "roomName": "测试房间",
      "gameMode": "normal",
      "status": "playing",
      "members": [
        { "name": "张三", "score": 10 },
        { "name": "李四", "score": -10 }
      ],
      "records": [],
      "creator": "张三",
      "createTime": "2026-01-16T14:00:00.000Z",
      "prizePool": {
        "total": 0,
        "receiver": "",
        "receivedTime": ""
      }
    }
  ]
}

// 用户信息
{
  "userInfo": {
    "nickName": "张三",
    "avatarUrl": "https://xxx.jpg"
  }
}
```

**注意：**
- 所有数据存储在本地，小程序卸载后数据会丢失
- 建议添加服务器存储功能（需自行开发后端）
- 结算后的战绩会上传到服务器（需配置接口）

## 五、测试用例

### 1. 普通模式测试

**测试步骤：**
1. 在主页点击「创建房间」
2. 选择「普通模式」
3. 输入房间名称（如：测试房间）
4. 点击「立即创建」
5. 添加成员（如：张三、李四）
6. 点击「张三」→ 输入「10」→ 确认转账
7. 验证：张三=-10，李四=10
8. 点击「结算」→ 非房主点击→ 提示「只有房主可以结算本局游戏」
9. 房主点击「结算」→ 确认结算
10. 验证：所有积分重置为0，显示战绩弹窗

**预期结果：**
- ✅ 转账后积分正确更新
- ✅ 非房主无法结算
- ✅ 房主可以结算并生成战绩

### 2. 下注模式测试

**测试步骤：**
1. 在主页点击「创建房间」
2. 选择「下注模式」
3. 输入房间名称（如：测试房间2）
4. 点击「立即创建」
5. 添加成员（如：张三、李四）
6. 点击奖池NPC → 输入「5」→ 确认转入
7. 验证：张三=-5，奖池=5
8. 李四点击奖池 → 输入「3」→ 确认转入
9. 验证：李四=-3，奖池=8
10. 张三点击「收取奖池」→ 确认收取
11. 验证：张三=3（-5+8），奖池=0，显示「张三收取了奖池」
12. 点击「结算」→ 确认结算
13. 验证：生成战绩，包含奖池信息

**预期结果：**
- ✅ 转入奖池后奖池总额正确更新
- ✅ 收取奖池后玩家积分增加，奖池清零
- ✅ 收取提示永久显示
- ✅ 战绩包含奖池信息

## 六、常见问题

### 1. 服务器上传失败

**问题：** 点击「上传服务器」提示「网络异常，点击重试」

**解决方案：**
1. 检查服务器接口地址是否正确配置
2. 检查服务器域名是否在合法域名列表中
3. 开发阶段可在开发者工具中勾选「不校验合法域名」
4. 检查服务器是否正常启动并监听请求

### 2. 保存到相册失败

**问题：** 点击「保存到相册」提示「需要相册权限」

**解决方案：**
1. 在小程序后台申请「保存到相册」权限
2. 确保用户已授权（点击设置→授权）
3. 开发阶段可在开发者工具中直接授权

### 3. 扫码无法加入房间

**问题：** 扫描二维码后提示「房间不存在」

**解决方案：**
1. 检查房间ID是否正确
2. 确保房间数据已保存到本地存储
3. 刷新小程序后重试

### 4. 积分计算错误

**问题：** 转账后积分不正确

**解决方案：**
1. 检查输入是否为正整数
2. 确认转出方和接收方是否正确
3. 刷新页面重新加载数据

## 七、后续优化建议

1. **数据持久化**：添加服务器存储，避免数据丢失
2. **实时同步**：使用WebSocket实现多人实时同步
3. **战绩统计**：添加战绩统计页面，展示历史战绩
4. **排行榜**：根据积分生成排行榜
5. **房间搜索**：添加房间搜索功能，方便加入公开房间
6. **消息通知**：添加操作通知（如转账、收取奖池）
7. **头像优化**：支持玩家上传自定义头像
8. **聊天功能**：添加房间内聊天功能

## 八、联系方式

如有问题，请联系开发团队。
